<?xml version="1.0" encoding="UTF-8" ?>
<XMLDB PATH="local/lmp_data_layer/db" VERSION="2025010100" COMMENT="XMLDB file for Moodle local/lmp_data_layer"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:noNamespaceSchemaLocation="../../../lib/xmldb/xmldb.xsd">

  <TABLES>

    <!-- Outbox table for events to be published to CMP -->
    <TABLE NAME="local_lmp_outbox" COMMENT="Outbox table for events published from LMP to CMP">
      <FIELDS>
        <FIELD NAME="id" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="true" COMMENT="ID of the event"/>
        <FIELD NAME="eventid" TYPE="char" LENGTH="100" NOTNULL="true" SEQUENCE="false" COMMENT="Event identifier like lmp_grade_submitted"/>
        <FIELD NAME="eventname" TYPE="char" LENGTH="255" NOTNULL="true" SEQUENCE="false" COMMENT="Human readable event name"/>
        <FIELD NAME="description" TYPE="text" NOTNULL="false" SEQUENCE="false" COMMENT="Event description"/>
        <FIELD NAME="eventpublishingenabled" TYPE="int" LENGTH="1" NOTNULL="true" DEFAULT="1" COMMENT="Whether event publishing is enabled"/>
        <FIELD NAME="createdby" TYPE="char" LENGTH="255" NOTNULL="true" SEQUENCE="false" COMMENT="User who created the event"/>
        <FIELD NAME="createdat" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="false" COMMENT="Timestamp when event was created"/>
        <FIELD NAME="updatedby" TYPE="char" LENGTH="255" NOTNULL="false" SEQUENCE="false" COMMENT="User who last updated the event"/>
        <FIELD NAME="updatedat" TYPE="int" LENGTH="10" NOTNULL="false" SEQUENCE="false" COMMENT="Timestamp when event was last updated"/>
        <FIELD NAME="tenantid" TYPE="char" LENGTH="50" NOTNULL="true" SEQUENCE="false" COMMENT="Tenant ID for multi-tenancy"/>
        <FIELD NAME="eventdata" TYPE="text" NOTNULL="false" SEQUENCE="false" COMMENT="JSON payload of the CloudEvent"/>
        <FIELD NAME="eventmetadata" TYPE="text" NOTNULL="false" SEQUENCE="false" COMMENT="Additional event metadata JSON"/>
        <FIELD NAME="status" TYPE="char" LENGTH="20" NOTNULL="true" DEFAULT="pending" SEQUENCE="false" COMMENT="Event status: pending, published, failed"/>
        <FIELD NAME="retrycount" TYPE="int" LENGTH="10" NOTNULL="true" DEFAULT="0" SEQUENCE="false" COMMENT="Number of retry attempts"/>
        <FIELD NAME="errormessage" TYPE="text" NOTNULL="false" SEQUENCE="false" COMMENT="Error message if event failed"/>
        <FIELD NAME="scheduleconfig" TYPE="text" NOTNULL="false" SEQUENCE="false" COMMENT="Schedule configuration JSON"/>
        <FIELD NAME="timecreated" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="false" COMMENT="Moodle timecreated"/>
        <FIELD NAME="timemodified" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="false" COMMENT="Moodle timemodified"/>
      </FIELDS>
      <KEYS>
        <KEY NAME="primary" TYPE="primary" FIELDS="id"/>
      </KEYS>
    </TABLE>

    <!-- Inbox table for events consumed from CMP -->
    <TABLE NAME="local_lmp_inbox" COMMENT="Inbox table for events consumed from CMP to LMP">
      <FIELDS>
        <FIELD NAME="id" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="true" COMMENT="ID of the event"/>
        <FIELD NAME="eventid" TYPE="char" LENGTH="100" NOTNULL="true" SEQUENCE="false" COMMENT="Event identifier like cmp_student_created"/>
        <FIELD NAME="eventname" TYPE="char" LENGTH="255" NOTNULL="true" SEQUENCE="false" COMMENT="Human readable event name"/>
        <FIELD NAME="description" TYPE="text" NOTNULL="false" SEQUENCE="false" COMMENT="Event description"/>
        <FIELD NAME="eventconsumingenabled" TYPE="int" LENGTH="1" NOTNULL="true" DEFAULT="1" COMMENT="Whether event consuming is enabled"/>
        <FIELD NAME="createdby" TYPE="char" LENGTH="255" NOTNULL="true" SEQUENCE="false" COMMENT="User who created the event"/>
        <FIELD NAME="createdat" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="false" COMMENT="Timestamp when event was created"/>
        <FIELD NAME="updatedby" TYPE="char" LENGTH="255" NOTNULL="false" SEQUENCE="false" COMMENT="User who last updated the event"/>
        <FIELD NAME="updatedat" TYPE="int" LENGTH="10" NOTNULL="false" SEQUENCE="false" COMMENT="Timestamp when event was last updated"/>
        <FIELD NAME="tenantid" TYPE="char" LENGTH="50" NOTNULL="true" SEQUENCE="false" COMMENT="Tenant ID for multi-tenancy"/>
        <FIELD NAME="eventdata" TYPE="text" NOTNULL="false" SEQUENCE="false" COMMENT="JSON payload of the CloudEvent"/>
        <FIELD NAME="eventmetadata" TYPE="text" NOTNULL="false" SEQUENCE="false" COMMENT="Additional event metadata JSON"/>
        <FIELD NAME="status" TYPE="char" LENGTH="20" NOTNULL="true" DEFAULT="received" SEQUENCE="false" COMMENT="Event status: received, processing, processed, failed"/>
        <FIELD NAME="retrycount" TYPE="int" LENGTH="10" NOTNULL="true" DEFAULT="0" SEQUENCE="false" COMMENT="Number of retry attempts"/>
        <FIELD NAME="errormessage" TYPE="text" NOTNULL="false" SEQUENCE="false" COMMENT="Error message if event failed"/>
        <FIELD NAME="fieldmappings" TYPE="text" NOTNULL="false" SEQUENCE="false" COMMENT="Field mapping configuration JSON"/>
        <FIELD NAME="scheduleconfig" TYPE="text" NOTNULL="false" SEQUENCE="false" COMMENT="Schedule configuration JSON"/>
        <FIELD NAME="timecreated" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="false" COMMENT="Moodle timecreated"/>
        <FIELD NAME="timemodified" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="false" COMMENT="Moodle timemodified"/>
      </FIELDS>
      <KEYS>
        <KEY NAME="primary" TYPE="primary" FIELDS="id"/>
      </KEYS>
    </TABLE>

    <!-- Audit log table for tracking changes -->
    <TABLE NAME="local_lmp_audit_log" COMMENT="Audit log table for tracking API and system changes">
      <FIELDS>
        <FIELD NAME="id" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="true" COMMENT="Primary key"/>
        <FIELD NAME="component" TYPE="char" LENGTH="50" NOTNULL="true" SEQUENCE="false" COMMENT="Component that made the change"/>
        <FIELD NAME="action" TYPE="char" LENGTH="50" NOTNULL="true" SEQUENCE="false" COMMENT="Action performed"/>
        <FIELD NAME="eventid" TYPE="char" LENGTH="36" NOTNULL="false" SEQUENCE="false" COMMENT="Event ID if applicable"/>
        <FIELD NAME="userid" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="false" COMMENT="User who made the change"/>
        <FIELD NAME="timecreated" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="false" COMMENT="Timestamp when change was made"/>
        <FIELD NAME="details" TYPE="text" NOTNULL="false" SEQUENCE="false" COMMENT="JSON details of the change"/>
      </FIELDS>
      <KEYS>
        <KEY NAME="primary" TYPE="primary" FIELDS="id"/>
      </KEYS>
    </TABLE>

  </TABLES>
</XMLDB>
